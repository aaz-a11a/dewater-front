<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Расчет степени обезвоживания</title>
    <link rel="stylesheet" href="/static/styles/dehydration_calc_style.css">
</head>
<body>
    <header>
        <a href="/" class="home-button">Домой</a>
        <h1>ОЦЕНКА ДЕГИДРАТАЦИИ</h1>
    </header>

    <div class="calculation-container">
        <h2>Расчет степени обезвоживания</h2>

        <!-- Сводка заявки и расчёт — сверху -->
        <section class="request-summary">
            <div class="calc-panel" style="grid-column: 1 / -1;">
                <div class="weight-input">
                    <label for="patient-weight">Масса тела пациента (кг):</label>
                    <input type="number" id="patient-weight" placeholder="кг" step="0.1" min="0">
                </div>
                <div class="result-box">
                    <div class="result-title">Результат расчёта дефицита жидкости (л):</div>
                    <div class="result-value" id="calc-result">-</div>
                </div>
            </div>
        </section>

        <div class="comment-section">
            <label for="doctor-comment">Комментарий врача:</label>
            <textarea id="doctor-comment" placeholder="Введите комментарий к заявке..." rows="2"></textarea>
        </div>

        <!-- Табличное представление симптомов: шапка с атрибутами 1 раз сверху -->
        <div class="symptoms-table-wrapper">
            <table class="symptoms-table" id="symptoms-table">
                <thead>
                    <tr>
                        <th>Симптом</th>
                        <th>Степень тяжести</th>
                        <th>Потеря веса</th>
                        <th>Потребность в жидкости</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .symptoms }}
                    <tr class="symptom-row" data-severity="{{ .Severity }}" data-fluidneed="{{ .FluidNeed }}">
                        <td class="symptom-name">
                            <div class="symptom-cell">
                                <img src="{{ $.minio_base }}/img/{{ .ImageURL }}" alt="{{ .Title }}" class="symptom-thumb">
                                <div>
                                    <div class="title">{{ .Title }}</div>
                                    <div class="desc">{{ .Description }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ .Severity }}</td>
                        <td>{{ .WeightLoss }}</td>
                        <td>{{ .FluidNeed }}</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>

        <form action="/clear-calc" method="POST" style="margin-top:16px;">
            <button type="submit" class="btn-delete-request">Очистить расчет</button>
        </form>
    </div>

    <script>
    (function() {
        const weightInput = document.getElementById('patient-weight');
        const resultEl = document.getElementById('calc-result');
        const rows = Array.from(document.querySelectorAll('#symptoms-table .symptom-row'));

        function severityToPercent(sev) {
            // приводим к нижнему регистру
            const s = (sev || '').toLowerCase();
            if (s.includes('тяжел') || s.includes('тяжёл')) return 8.0; // тяжёлая (7-9%) ~ 8
            if (s.includes('средн')) return 4.5; // средняя (3-6%) ~ 4.5
            if (s.includes('легк') || s.includes('лёгк')) return 1.5; // лёгкая (1-2%) ~ 1.5
            // fallback: попробуем вытащить числа вида "x-y%"
            const m = s.match(/(\d+[\.,]?\d*)\s*-\s*(\d+[\.,]?\d*)\s*%/);
            if (m) {
                const a = parseFloat(m[1].replace(',', '.'));
                const b = parseFloat(m[2].replace(',', '.'));
                return (a + b) / 2.0;
            }
            return 0;
        }

        function recalc() {
            const w = parseFloat(weightInput.value);
            if (!w || w <= 0) { resultEl.textContent = '-'; return; }
            const percents = rows.map(r => severityToPercent(r.dataset.severity)).filter(v => v > 0);
            if (percents.length === 0) { resultEl.textContent = '-'; return; }
            const p = percents.reduce((a,b)=>a+b,0) / percents.length;
            const D = w * p / 100.0;
            resultEl.textContent = D.toFixed(2) + ' л (p ≈ ' + p.toFixed(1) + '%)';
        }

        weightInput?.addEventListener('input', recalc);
    })();
    </script>
</body>
</html>